<!doctype html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>üê± Save The Cat ‚Äî Side Story</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=VT323&display=swap"
      rel="stylesheet"
    />
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        image-rendering: pixelated;
      }

      body {
        background: #1a1a2e;
        min-height: 100vh;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        font-family: "VT323", monospace;
        overflow: hidden;
      }

      .game-wrapper {
        position: relative;
        border: 4px solid #3d3d5c;
        border-radius: 8px;
        box-shadow: 0 0 40px rgba(100, 100, 200, 0.3);
      }

      .music-toggle {
        position: absolute;
        top: 10px;
        right: 10px;
        width: 40px;
        height: 40px;
        background: rgba(0, 0, 0, 0.5);
        border: 2px solid #5a5a8a;
        border-radius: 8px;
        color: #fff;
        font-size: 20px;
        cursor: pointer;
        z-index: 100;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s;
        -webkit-tap-highlight-color: transparent;
      }

      .music-toggle:hover {
        background: rgba(0, 0, 0, 0.7);
        transform: scale(1.1);
      }

      .music-toggle:active {
        transform: scale(0.95);
      }

      .music-toggle.muted {
        opacity: 0.5;
      }

      .time-toggle {
        position: absolute;
        top: 10px;
        left: 10px;
        background: rgba(0, 0, 0, 0.5);
        border: 2px solid #5a5a8a;
        border-radius: 8px;
        color: #fff;
        font-size: 12px;
        cursor: pointer;
        z-index: 100;
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 8px 12px;
        transition: all 0.2s;
        -webkit-tap-highlight-color: transparent;
        font-family: "Press Start 2P", cursive;
      }

      .time-toggle:hover {
        background: rgba(0, 0, 0, 0.7);
        transform: scale(1.05);
      }

      .time-toggle:active {
        transform: scale(0.95);
      }

      .time-icon {
        font-size: 16px;
      }

      .time-label {
        font-size: 8px;
      }

      #gameCanvas {
        display: block;
        background: #87ceeb;
      }

      .controls-hint {
        color: #888;
        font-size: 14px;
        margin-top: 15px;
        text-align: center;
        font-family: "VT323", monospace;
      }

      .controls-hint span {
        color: #ffd700;
        background: #333;
        padding: 2px 8px;
        border-radius: 3px;
        margin: 0 3px;
      }

      /* Dialog Box */
      .dialog-overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 100;
        padding: 10px;
      }

      .dialog-overlay.active {
        display: flex;
      }

      .dialog-box {
        background: #2a2a4a;
        border: 4px solid #5a5a8a;
        border-radius: 8px;
        padding: 20px 25px;
        max-width: 380px;
        width: 100%;
        color: #fff;
        font-family: "VT323", monospace;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
        animation: dialogPop 0.2s ease-out;
        max-height: 90vh;
        overflow-y: auto;
      }

      @keyframes dialogPop {
        from {
          transform: scale(0.8);
          opacity: 0;
        }
        to {
          transform: scale(1);
          opacity: 1;
        }
      }

      .dialog-title {
        font-family: "Press Start 2P", cursive;
        font-size: 12px;
        color: #ffd700;
        margin-bottom: 15px;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .dialog-title .icon {
        font-size: 18px;
      }

      .dialog-content {
        font-size: 18px;
        line-height: 1.6;
        color: #ddd;
        margin-bottom: 20px;
        white-space: pre-line;
      }

      .dialog-content .rule {
        display: block;
        margin: 8px 0;
        padding-left: 15px;
        color: #aaddff;
      }

      .dialog-content .rule::before {
        content: "‚ñ∏ ";
        color: #ffd700;
      }

      .dialog-buttons {
        display: flex;
        gap: 10px;
        justify-content: flex-end;
      }

      .dialog-btn {
        font-family: "Press Start 2P", cursive;
        font-size: 10px;
        padding: 10px 20px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        transition: all 0.2s;
        -webkit-tap-highlight-color: transparent;
        min-width: 80px;
        touch-action: manipulation;
      }

      .dialog-btn.primary {
        background: #4a7c59;
        color: white;
      }

      .dialog-btn.primary:hover {
        background: #5a9c69;
        transform: translateY(-2px);
      }

      .dialog-btn.primary:active {
        background: #3a6c49;
        transform: translateY(0);
      }

      .dialog-btn.secondary {
        background: #4a4a6a;
        color: #ccc;
      }

      .dialog-btn.secondary:hover {
        background: #5a5a7a;
      }

      .dialog-btn.secondary:active {
        background: #3a3a5a;
      }

      .whatsapp-btn {
        display: none;
        width: 100%;
        padding: 12px 20px;
        background: #25d366;
        color: #fff;
        border: 3px solid #128c7e;
        border-radius: 8px;
        font-family: "Press Start 2P", cursive;
        font-size: 9px;
        cursor: pointer;
        margin-bottom: 10px;
        text-decoration: none;
        text-align: center;
        transition: all 0.2s;
        -webkit-tap-highlight-color: transparent;
        touch-action: manipulation;
      }

      .whatsapp-btn:hover {
        background: #128c7e;
        transform: scale(1.02);
      }

      .whatsapp-btn:active {
        background: #0f7a6d;
        transform: scale(0.98);
      }

      .whatsapp-btn .wa-icon {
        font-size: 14px;
        margin-right: 8px;
      }

      /* Code Input */
      .code-input-wrapper {
        margin: 15px 0;
      }

      .code-input {
        font-family: "Press Start 2P", cursive;
        font-size: 14px;
        padding: 12px 15px;
        width: 100%;
        background: #1a1a2e;
        border: 3px solid #5a5a8a;
        border-radius: 4px;
        color: #ffd700;
        text-align: center;
        text-transform: uppercase;
        letter-spacing: 3px;
      }

      .code-input:focus {
        outline: none;
        border-color: #8a8aba;
        box-shadow: 0 0 10px rgba(138, 138, 186, 0.3);
      }

      .code-input::placeholder {
        color: #555;
        letter-spacing: 1px;
      }

      /* Ending Screen */
      .ending-overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: #1a1a2e;
        display: none;
        align-items: center;
        justify-content: center;
        flex-direction: column;
        z-index: 200;
        opacity: 0;
        transition: opacity 1s ease;
      }

      .ending-overlay.active {
        display: flex;
      }

      .ending-overlay.visible {
        opacity: 1;
      }

      .ending-text {
        font-family: "VT323", monospace;
        font-size: 18px;
        color: #aaa;
        text-align: center;
        line-height: 1.5;
        max-width: 680px;
        padding: 25px 30px;
        background: rgba(0, 0, 0, 0.4);
        border-radius: 15px;
        border: 2px solid rgba(136, 204, 255, 0.3);
        box-shadow: 0 0 30px rgba(136, 204, 255, 0.2);
      }

      .ending-text .main {
        color: #88ccff;
        font-size: 26px;
        margin-bottom: 8px;
        font-weight: bold;
        text-shadow: 0 0 10px rgba(136, 204, 255, 0.5);
        animation: fadeInDown 1s ease-out;
      }

      .ending-text .cat-emoji {
        animation: bounceIn 1s ease-out;
      }

      .ending-text .line1 {
        animation: fadeIn 1.2s ease-out 0.3s backwards;
      }

      .ending-text .line2 {
        animation: fadeIn 1.2s ease-out 0.6s backwards;
      }

      .ending-text .question {
        animation: fadeIn 1.2s ease-out 0.9s backwards;
      }

      @keyframes fadeInDown {
        from {
          opacity: 0;
          transform: translateY(-20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
        }
        to {
          opacity: 1;
        }
      }

      @keyframes bounceIn {
        0% {
          opacity: 0;
          transform: scale(0.3);
        }
        50% {
          transform: scale(1.1);
        }
        70% {
          transform: scale(0.9);
        }
        100% {
          opacity: 1;
          transform: scale(1);
        }
      }

      @keyframes buttonGlow {
        0%,
        100% {
          box-shadow: 0 6px 20px rgba(37, 211, 102, 0.4);
        }
        50% {
          box-shadow: 0 6px 30px rgba(37, 211, 102, 0.7);
        }
      }

      .wa-button {
        margin-top: 18px;
        padding: 12px 28px;
        background: linear-gradient(135deg, #25d366, #128c7e);
        color: white;
        border: none;
        border-radius: 50px;
        font-family: "Press Start 2P", cursive;
        font-size: 11px;
        cursor: pointer;
        box-shadow: 0 6px 20px rgba(37, 211, 102, 0.4);
        transition: all 0.3s ease;
        text-decoration: none;
        display: inline-flex;
        animation:
          fadeIn 1.2s ease-out 1.2s backwards,
          buttonGlow 2s ease-in-out infinite;
        align-items: center;
        gap: 10px;
        -webkit-tap-highlight-color: transparent;
      }

      .wa-button:hover {
        transform: translateY(-3px);
        box-shadow: 0 8px 25px rgba(37, 211, 102, 0.6);
        background: linear-gradient(135deg, #2ee673, #15a889);
      }

      .wa-button:active {
        transform: translateY(-1px);
        box-shadow: 0 4px 15px rgba(37, 211, 102, 0.5);
      }

      /* Intro Overlay */
      .intro-overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: linear-gradient(135deg, #0f0c29, #302b63, #24243e);
        display: flex;
        align-items: center;
        justify-content: center;
        flex-direction: column;
        z-index: 300;
        opacity: 1;
        transition: opacity 0.8s ease;
        padding: 20px;
      }

      .intro-overlay.hidden {
        opacity: 0;
        pointer-events: none;
      }

      .intro-content {
        max-width: 700px;
        text-align: center;
        color: #fff;
      }

      .intro-title {
        font-family: "Press Start 2P", cursive;
        font-size: 28px;
        color: #88ccff;
        margin-bottom: 20px;
        text-shadow: 0 0 20px rgba(136, 204, 255, 0.8);
        animation: glow 2s ease-in-out infinite;
      }

      @keyframes glow {
        0%,
        100% {
          text-shadow: 0 0 20px rgba(136, 204, 255, 0.8);
        }
        50% {
          text-shadow:
            0 0 30px rgba(136, 204, 255, 1),
            0 0 40px rgba(136, 204, 255, 0.6);
        }
      }

      .narrative-text {
        font-family: "VT323", monospace;
        font-size: 22px;
        line-height: 1.6;
        color: #ddd;
        margin-bottom: 30px;
        min-height: 120px;
        padding: 20px;
        background: rgba(0, 0, 0, 0.3);
        border-radius: 10px;
        border: 1px solid rgba(136, 204, 255, 0.2);
      }

      .typing-cursor {
        display: inline-block;
        width: 8px;
        height: 20px;
        background: #88ccff;
        margin-left: 4px;
        animation: blink 0.8s infinite;
      }

      @keyframes blink {
        0%,
        50% {
          opacity: 1;
        }
        51%,
        100% {
          opacity: 0;
        }
      }

      .tutorials {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 15px;
        margin-bottom: 25px;
        opacity: 0;
        animation: fadeIn 0.8s ease-out 4s forwards;
      }

      .tutorial-item {
        background: rgba(0, 0, 0, 0.4);
        padding: 12px;
        border-radius: 8px;
        border: 1px solid rgba(136, 204, 255, 0.3);
        font-family: "VT323", monospace;
        font-size: 16px;
        color: #ccc;
      }

      .tutorial-icon {
        font-size: 24px;
        margin-bottom: 5px;
      }

      .start-button {
        font-family: "Press Start 2P", cursive;
        font-size: 14px;
        padding: 15px 40px;
        background: linear-gradient(135deg, #667eea, #764ba2);
        color: white;
        border: none;
        border-radius: 50px;
        cursor: pointer;
        box-shadow: 0 6px 25px rgba(102, 126, 234, 0.5);
        transition: all 0.3s ease;
        opacity: 0;
        animation:
          fadeIn 0.8s ease-out 4.5s forwards,
          pulse 2s ease-in-out 5s infinite;
      }

      .start-button:hover {
        transform: translateY(-3px);
        box-shadow: 0 8px 30px rgba(102, 126, 234, 0.7);
      }

      .start-button:active {
        transform: translateY(-1px);
      }

      @keyframes pulse {
        0%,
        100% {
          transform: scale(1);
        }
        50% {
          transform: scale(1.05);
        }
      }

      /* Interaction Prompt */
      .interact-prompt {
        position: absolute;
        display: none;
        pointer-events: none;
        z-index: 50;
        flex-direction: column;
        align-items: center;
        gap: 5px;
        transform-origin: center;
      }

      .interact-prompt.visible {
        display: flex;
        animation: promptBounce 0.5s ease-in-out infinite;
      }

      .prompt-icon {
        background: #ffd700;
        color: #000;
        width: 24px;
        height: 24px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        font-size: 16px;
        box-shadow: 0 2px 8px rgba(255, 215, 0, 0.5);
      }

      .prompt-text {
        background: rgba(0, 0, 0, 0.8);
        color: #ffd700;
        font-family: "Press Start 2P", cursive;
        font-size: 8px;
        padding: 6px 10px;
        border-radius: 4px;
        white-space: nowrap;
        border: 2px solid #ffd700;
      }

      @keyframes promptBounce {
        0%,
        100% {
          transform: translateY(0);
        }
        50% {
          transform: translateY(-5px);
        }
      }

      /* Mobile Controls */
      .mobile-controls {
        display: none;
        margin-top: 20px;
        gap: 15px;
        padding: 10px;
        justify-content: center;
        align-items: center;
      }

      .mobile-btn {
        width: 70px;
        height: 70px;
        background: #3d3d5c;
        border: 3px solid #5a5a8a;
        border-radius: 12px;
        color: #fff;
        font-size: 28px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        user-select: none;
        -webkit-user-select: none;
        touch-action: manipulation;
        -webkit-tap-highlight-color: transparent;
        transition: all 0.1s;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        font-family: "Press Start 2P", cursive;
        font-size: 12px;
      }

      .mobile-btn:active {
        background: #5a5a8a;
        transform: scale(0.92);
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.4);
      }

      .mobile-btn.action {
        background: #4a7c59;
        width: 90px;
        font-size: 20px;
      }

      .mobile-btn.action:active {
        background: #5a9c69;
      }

      .mobile-btn::before {
        content: attr(data-label);
        font-size: 24px;
      }

      @media (max-width: 800px) {
        .mobile-controls {
          display: flex;
        }
        .controls-hint {
          display: none;
        }

        body {
          padding: 0;
          justify-content: flex-start;
        }

        .music-toggle {
          width: 50px;
          height: 50px;
          font-size: 24px;
          top: 15px;
          right: 15px;
        }

        .time-toggle {
          top: 15px;
          left: 15px;
          padding: 10px 14px;
        }

        .time-icon {
          font-size: 18px;
        }

        .time-label {
          font-size: 7px;
        }

        .dialog-box {
          padding: 20px;
          margin: 15px;
        }

        .dialog-title {
          font-size: 11px;
        }

        .dialog-content {
          font-size: 20px;
        }

        .dialog-btn {
          font-size: 11px;
          padding: 14px 24px;
          min-width: 100px;
        }

        .whatsapp-btn {
          padding: 14px 20px;
          font-size: 10px;
        }

        .prompt-icon {
          width: 28px;
          height: 28px;
          font-size: 18px;
        }

        .prompt-text {
          font-size: 10px;
          padding: 8px 12px;
        }
      }

      @media (max-width: 700px) {
        #gameCanvas {
          width: 100vw;
          height: auto;
        }
        .game-wrapper {
          border: none;
          border-radius: 0;
          box-shadow: none;
        }
      }

      @media (max-width: 500px) {
        .mobile-btn {
          width: 65px;
          height: 65px;
        }

        .mobile-btn.action {
          width: 80px;
        }

        .dialog-title {
          font-size: 10px;
          flex-direction: column;
          align-items: flex-start;
          gap: 5px;
        }

        .dialog-buttons {
          flex-direction: column;
          gap: 8px;
        }

        .dialog-btn {
          width: 100%;
        }
      }

      @media (orientation: landscape) and (max-height: 500px) {
        body {
          overflow-y: auto;
        }

        .game-wrapper {
          margin: 10px 0;
        }

        .mobile-controls {
          margin-top: 10px;
          margin-bottom: 10px;
        }
      }
    </style>
  </head>
  <body>
    <div class="game-wrapper">
      <!-- Lofi Music -->
      <audio id="bgMusic" loop preload="auto">
        <source
          src="https://cdn.pixabay.com/audio/2022/05/27/audio_1808fbf07a.mp3"
          type="audio/mpeg"
        />
      </audio>

      <button class="music-toggle" id="musicToggle" title="Toggle Music">
        üéµ
      </button>

      <button class="time-toggle" id="timeToggle" title="Change Time">
        <span class="time-icon" id="timeIcon">‚òÄÔ∏è</span>
        <span class="time-label" id="timeLabel">PAGI</span>
      </button>

      <canvas id="gameCanvas" width="800" height="400"></canvas>

      <!-- Intro Overlay -->
      <div class="intro-overlay" id="introOverlay">
        <div class="intro-content">
          <div class="intro-title">üê± Save The Cat</div>
          <div class="narrative-text" id="narrativeText">
            <span id="typedText"></span
            ><span class="typing-cursor" id="cursor"></span>
          </div>
          <div class="tutorials" id="tutorials">
            <div class="tutorial-item">
              <div class="tutorial-icon">‚¨ÖÔ∏è‚û°Ô∏è</div>
              <div>Gerak: Arrow Keys</div>
              <div style="font-size: 14px; color: #999">atau tombol mobile</div>
            </div>
            <div class="tutorial-item">
              <div class="tutorial-icon">‚ùó</div>
              <div>Interaksi: Tekan E</div>
              <div style="font-size: 14px; color: #999">saat ada tanda !</div>
            </div>
            <div class="tutorial-item">
              <div class="tutorial-icon">‚òÄÔ∏èüåô</div>
              <div>Ganti Waktu</div>
              <div style="font-size: 14px; color: #999">
                klik tombol kiri atas
              </div>
            </div>
            <div class="tutorial-item">
              <div class="tutorial-icon">üéµ</div>
              <div>Toggle Music</div>
              <div style="font-size: 14px; color: #999">
                klik tombol kanan atas
              </div>
            </div>
          </div>
          <button class="start-button" id="startButton">
            Mulai Petualangan
          </button>
        </div>
      </div>

      <div class="interact-prompt" id="interactPrompt">
        <div class="prompt-icon">!</div>
        <div class="prompt-text">Tekan E</div>
      </div>

      <!-- Dialog Overlay -->
      <div class="dialog-overlay" id="dialogOverlay">
        <div class="dialog-box">
          <div class="dialog-title">
            <span class="icon" id="dialogIcon">üìï</span>
            <span id="dialogTitle">Judul</span>
          </div>
          <div class="dialog-content" id="dialogContent">Konten dialog</div>
          <div
            class="code-input-wrapper"
            id="codeInputWrapper"
            style="display: none"
          >
            <input
              type="text"
              class="code-input"
              id="codeInput"
              placeholder="_ _ _ _ _"
              maxlength="10"
            />
          </div>
          <a
            href="https://wa.me/6285777203153?text=Halo%2C%20saya%20butuh%20kode%20untuk%20Save%20the%20Cat!"
            target="_blank"
            class="whatsapp-btn"
            id="whatsappBtn"
          >
            <span class="wa-icon">üí¨</span>Minta Kode via WhatsApp
          </a>
          <div class="dialog-buttons" id="dialogButtons">
            <button class="dialog-btn secondary" id="btnSecondary">
              Tutup
            </button>
            <button class="dialog-btn primary" id="btnPrimary">OK</button>
          </div>
        </div>
      </div>

      <!-- Ending Overlay -->
      <div class="ending-overlay" id="endingOverlay">
        <div class="ending-text">
          <div class="cat-emoji" style="font-size: 38px; margin-bottom: 8px">
            ÔøΩ
          </div>
          <div class="main">
            Congrats, kamu berhasil<br />nyelametin si kucing
          </div>
          <div
            class="line1"
            style="color: #ccc; font-size: 19px; margin: 8px 0"
          >
            Kayaknya dia aman sekarang‚Ä¶
          </div>
          <div
            class="line2"
            style="color: #aaa; font-size: 17px; margin: 10px 0 6px 0"
          >
            tapi aku masih penasaran:
          </div>
          <div
            class="question"
            style="
              color: #88ccff;
              font-size: 19px;
              margin-top: 6px;
              font-weight: bold;
              text-shadow: 0 0 8px rgba(136, 204, 255, 0.4);
            "
          >
            menurut kamu, dia bakal hidup<br />paling bahagia sama siapa?
          </div>
          <button
            class="wa-button"
            onclick="window.open('https://wa.me/6285777203153', '_blank')"
          >
            <span style="font-size: 16px">üí¨</span>
            Lanjutin ceritanya di WhatsApp
          </button>
        </div>
      </div>
    </div>

    <p class="controls-hint">
      <span>‚Üê</span> <span>‚Üí</span> Jalan &nbsp;&nbsp; <span>E</span> atau
      <span>‚Üë</span> Interaksi
    </p>

    <div class="mobile-controls">
      <button
        class="mobile-btn"
        id="btnLeft"
        data-label="‚óÄ"
        aria-label="Gerak Kiri"
      ></button>
      <button
        class="mobile-btn action"
        id="btnAction"
        data-label="E"
        aria-label="Interaksi"
      ></button>
      <button
        class="mobile-btn"
        id="btnRight"
        data-label="‚ñ∂"
        aria-label="Gerak Kanan"
      ></button>
    </div>

    <script>
      // ==================== MUSIC CONTROL ====================
      const bgMusic = document.getElementById("bgMusic");
      const musicToggle = document.getElementById("musicToggle");
      let musicStarted = false;
      bgMusic.volume = 0.3;

      function startMusic() {
        if (!musicStarted) {
          bgMusic.play().catch(() => {});
          musicStarted = true;
        }
      }

      musicToggle.addEventListener("click", () => {
        if (bgMusic.paused) {
          bgMusic.play();
          musicToggle.textContent = "üéµ";
          musicToggle.classList.remove("muted");
        } else {
          bgMusic.pause();
          musicToggle.textContent = "üîá";
          musicToggle.classList.add("muted");
        }
        musicStarted = true;
      });

      document.addEventListener("keydown", startMusic, { once: true });
      document.addEventListener("click", startMusic, { once: true });
      document.addEventListener("touchstart", startMusic, { once: true });

      // ==================== INTRO SCREEN ====================
      const introOverlay = document.getElementById("introOverlay");
      const narrativeText = document.getElementById("narrativeText");
      const typedText = document.getElementById("typedText");
      const cursor = document.getElementById("cursor");
      const startButton = document.getElementById("startButton");
      const tutorials = document.getElementById("tutorials");

      const storyText =
        "Malam yang dingin... Di sudut kota, seekor kucing terjebak di atas pohon. Dia menangis meminta tolong, tapi jalanan sepi. Kamu adalah satu-satunya harapannya. Bisakah kamu menyelamatkannya?";
      let charIndex = 0;
      let typingInterval;

      function typeWriter() {
        if (charIndex < storyText.length) {
          typedText.textContent += storyText.charAt(charIndex);
          charIndex++;
        } else {
          clearInterval(typingInterval);
          cursor.style.display = "none";
        }
      }

      // Start typing animation
      setTimeout(() => {
        typingInterval = setInterval(typeWriter, 50);
      }, 500);

      startButton.addEventListener("click", () => {
        state.introPassed = true;
        introOverlay.classList.add("hidden");
        setTimeout(() => {
          introOverlay.style.display = "none";
        }, 800);
        startMusic();
      });

      // Skip intro with Enter key
      document.addEventListener("keydown", (e) => {
        if (!state.introPassed && e.key === "Enter") {
          startButton.click();
        }
      });

      // ==================== SOUND EFFECTS ====================
      const AudioContext = window.AudioContext || window.webkitAudioContext;
      const audioCtx = new AudioContext();
      let soundEnabled = true;

      // Sound effect functions using Web Audio API
      function playFootstep() {
        if (!soundEnabled) return;
        const oscillator = audioCtx.createOscillator();
        const gainNode = audioCtx.createGain();

        oscillator.connect(gainNode);
        gainNode.connect(audioCtx.destination);

        oscillator.frequency.value = 100;
        oscillator.type = "sine";

        gainNode.gain.setValueAtTime(0.1, audioCtx.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(
          0.01,
          audioCtx.currentTime + 0.05,
        );

        oscillator.start(audioCtx.currentTime);
        oscillator.stop(audioCtx.currentTime + 0.05);
      }

      function playDing() {
        if (!soundEnabled) return;
        const oscillator = audioCtx.createOscillator();
        const gainNode = audioCtx.createGain();

        oscillator.connect(gainNode);
        gainNode.connect(audioCtx.destination);

        oscillator.frequency.value = 800;
        oscillator.type = "sine";

        gainNode.gain.setValueAtTime(0.3, audioCtx.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(
          0.01,
          audioCtx.currentTime + 0.3,
        );

        oscillator.start(audioCtx.currentTime);
        oscillator.stop(audioCtx.currentTime + 0.3);
      }

      function playBuzz() {
        if (!soundEnabled) return;
        const oscillator = audioCtx.createOscillator();
        const gainNode = audioCtx.createGain();

        oscillator.connect(gainNode);
        gainNode.connect(audioCtx.destination);

        oscillator.frequency.value = 150;
        oscillator.type = "sawtooth";

        gainNode.gain.setValueAtTime(0.2, audioCtx.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(
          0.01,
          audioCtx.currentTime + 0.2,
        );

        oscillator.start(audioCtx.currentTime);
        oscillator.stop(audioCtx.currentTime + 0.2);
      }

      function playMeow() {
        if (!soundEnabled) return;
        // Simple meow simulation with frequency sweep
        const oscillator = audioCtx.createOscillator();
        const gainNode = audioCtx.createGain();

        oscillator.connect(gainNode);
        gainNode.connect(audioCtx.destination);

        oscillator.type = "sawtooth";
        oscillator.frequency.setValueAtTime(400, audioCtx.currentTime);
        oscillator.frequency.linearRampToValueAtTime(
          600,
          audioCtx.currentTime + 0.1,
        );
        oscillator.frequency.linearRampToValueAtTime(
          300,
          audioCtx.currentTime + 0.3,
        );

        gainNode.gain.setValueAtTime(0.2, audioCtx.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(
          0.01,
          audioCtx.currentTime + 0.4,
        );

        oscillator.start(audioCtx.currentTime);
        oscillator.stop(audioCtx.currentTime + 0.4);
      }

      function playVictory() {
        if (!soundEnabled) return;
        // Happy victory jingle
        const notes = [523.25, 587.33, 659.25, 783.99]; // C, D, E, G
        notes.forEach((freq, i) => {
          const oscillator = audioCtx.createOscillator();
          const gainNode = audioCtx.createGain();

          oscillator.connect(gainNode);
          gainNode.connect(audioCtx.destination);

          oscillator.frequency.value = freq;
          oscillator.type = "sine";

          const startTime = audioCtx.currentTime + i * 0.15;
          gainNode.gain.setValueAtTime(0.2, startTime);
          gainNode.gain.exponentialRampToValueAtTime(0.01, startTime + 0.3);

          oscillator.start(startTime);
          oscillator.stop(startTime + 0.3);
        });
      }

      function playPurr() {
        if (!soundEnabled) return;
        // Continuous purring sound
        const oscillator = audioCtx.createOscillator();
        const gainNode = audioCtx.createGain();
        const lfo = audioCtx.createOscillator();
        const lfoGain = audioCtx.createGain();

        lfo.frequency.value = 25; // Purr vibrato
        lfoGain.gain.value = 10;

        lfo.connect(lfoGain);
        lfoGain.connect(oscillator.frequency);

        oscillator.connect(gainNode);
        gainNode.connect(audioCtx.destination);

        oscillator.frequency.value = 100;
        oscillator.type = "sine";

        gainNode.gain.setValueAtTime(0.15, audioCtx.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(
          0.01,
          audioCtx.currentTime + 1.5,
        );

        oscillator.start(audioCtx.currentTime);
        lfo.start(audioCtx.currentTime);
        oscillator.stop(audioCtx.currentTime + 1.5);
        lfo.stop(audioCtx.currentTime + 1.5);
      }

      function playAmbient() {
        if (!soundEnabled) return;
        // Subtle bird chirp
        const oscillator = audioCtx.createOscillator();
        const gainNode = audioCtx.createGain();

        oscillator.connect(gainNode);
        gainNode.connect(audioCtx.destination);

        oscillator.type = "sine";
        oscillator.frequency.setValueAtTime(2000, audioCtx.currentTime);
        oscillator.frequency.linearRampToValueAtTime(
          2500,
          audioCtx.currentTime + 0.05,
        );
        oscillator.frequency.linearRampToValueAtTime(
          2200,
          audioCtx.currentTime + 0.1,
        );

        gainNode.gain.setValueAtTime(0.05, audioCtx.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(
          0.01,
          audioCtx.currentTime + 0.15,
        );

        oscillator.start(audioCtx.currentTime);
        oscillator.stop(audioCtx.currentTime + 0.15);
      }

      // Ambient sound loop
      let ambientInterval;
      function startAmbientSounds() {
        if (ambientInterval) return;
        ambientInterval = setInterval(() => {
          if (Math.random() < 0.3) {
            // 30% chance every interval
            playAmbient();
          }
        }, 3000);
      }

      // Start ambient sounds on user interaction
      document.addEventListener(
        "keydown",
        () => {
          audioCtx.resume();
          startAmbientSounds();
        },
        { once: true },
      );
      document.addEventListener(
        "click",
        () => {
          audioCtx.resume();
          startAmbientSounds();
        },
        { once: true },
      );
      document.addEventListener(
        "touchstart",
        () => {
          audioCtx.resume();
          startAmbientSounds();
        },
        { once: true },
      );

      // Toggle sound effects with music button
      musicToggle.addEventListener("click", () => {
        soundEnabled = !bgMusic.paused;
      });

      // ==================== GAME CONFIG ====================
      const CONFIG = {
        SECRET_CODE: "MEOW23",
        GAME_WIDTH: 800,
        GAME_HEIGHT: 400,
        GROUND_Y: 320,
        PLAYER_SPEED: 3,
      };

      // ==================== TIME OF DAY SYSTEM ====================
      const TIME_OF_DAY = {
        MORNING: {
          name: "PAGI",
          icon: "‚òÄÔ∏è",
          skyGradient: ["#9EC8E8", "#B8E0F6", "#E3F4FF", "#FFF8E7"],
          cloudOpacity: 0.9,
          lampBrightness: 0,
          windowLights: false,
          stars: false,
          ambientSound: true,
        },
        NOON: {
          name: "SIANG",
          icon: "üå§Ô∏è",
          skyGradient: ["#4A90E2", "#6BB3F1", "#87CEEB", "#B8E2F7"],
          cloudOpacity: 0.95,
          lampBrightness: 0,
          windowLights: false,
          stars: false,
          ambientSound: true,
        },
        EVENING: {
          name: "SORE",
          icon: "üåÖ",
          skyGradient: ["#7B2869", "#E85D75", "#FFAB73", "#FFD6A5"],
          cloudOpacity: 0.7,
          lampBrightness: 0.5,
          windowLights: true,
          stars: false,
          ambientSound: false,
        },
        NIGHT: {
          name: "MALAM",
          icon: "üåô",
          skyGradient: ["#0A0E27", "#1A1F3A", "#2B3A5C", "#3D506E"],
          cloudOpacity: 0.3,
          lampBrightness: 1,
          windowLights: true,
          stars: true,
          ambientSound: false,
        },
      };

      const timeOrder = ["MORNING", "NOON", "EVENING", "NIGHT"];
      let currentTimeIndex = 0;
      let currentTime = TIME_OF_DAY[timeOrder[currentTimeIndex]];

      // Star positions for night sky
      const stars = [];
      for (let i = 0; i < 50; i++) {
        stars.push({
          x: Math.random() * CONFIG.GAME_WIDTH,
          y: Math.random() * (CONFIG.GROUND_Y - 100),
          size: Math.random() * 2 + 1,
          brightness: Math.random(),
          twinkleSpeed: Math.random() * 0.02 + 0.01,
        });
      }

      // Time toggle button
      const timeToggle = document.getElementById("timeToggle");
      const timeIcon = document.getElementById("timeIcon");
      const timeLabel = document.getElementById("timeLabel");

      function changeTimeOfDay() {
        currentTimeIndex = (currentTimeIndex + 1) % timeOrder.length;
        currentTime = TIME_OF_DAY[timeOrder[currentTimeIndex]];
        timeIcon.textContent = currentTime.icon;
        timeLabel.textContent = currentTime.name;

        // Update ambient sounds
        if (currentTime.ambientSound && !ambientInterval) {
          startAmbientSounds();
        } else if (!currentTime.ambientSound && ambientInterval) {
          clearInterval(ambientInterval);
          ambientInterval = null;
        }
      }

      timeToggle.addEventListener("click", changeTimeOfDay);

      // ==================== ANIMATION STATE ====================
      const anim = {
        time: 0,
        clouds: [
          { x: 100, speed: 0.3 },
          { x: 350, speed: 0.2 },
          { x: 600, speed: 0.35 },
          { x: 750, speed: 0.25 },
        ],
        catTail: 0,
        treeSway: 0,
        lampFlicker: 1,
        grassWave: 0,
      };

      // ==================== GAME STATE ====================
      const state = {
        introPassed: false,
        treeInteracted: false,
        ladderTried: false,
        stoneTried: false,
        foodTried: false,
        bookRead: false,
        phoneUnlocked: false,
        codeEntered: false,
        gameComplete: false,
        currentDialog: null,
        cutscene: {
          active: false,
          phase: 0, // 0: zoom to cat, 1: pickup, 2: thank you, 3: walk home, 4: photo
          timer: 0,
          zoomLevel: 1,
          targetZoom: 1,
          cameraX: 0,
          cameraY: 0,
        },
      };

      // ==================== CANVAS SETUP ====================
      const canvas = document.getElementById("gameCanvas");
      const ctx = canvas.getContext("2d");

      // ==================== PLAYER ====================
      const player = {
        x: 400,
        y: CONFIG.GROUND_Y,
        width: 32,
        height: 48,
        speed: CONFIG.PLAYER_SPEED,
        direction: 1,
        frame: 0,
        carryingCat: false,
        frameTimer: 0,
        isWalking: false,
      };

      // ==================== OBJECTS ====================
      const objects = {
        tree: {
          x: 60,
          y: CONFIG.GROUND_Y - 120,
          width: 100,
          height: 120,
          interactRange: 60,
        },
        cat: {
          x: 85,
          y: CONFIG.GROUND_Y - 155,
          width: 30,
          height: 25,
          rescued: false,
          state: "stuck", // stuck, descending, walkingToPlayer, rubbing, following, idle
          targetX: 0,
          frame: 0,
          frameTimer: 0,
          direction: 1,
          rubbingTimer: 0,
          carried: false,
        },
        ladder: {
          x: 180,
          y: CONFIG.GROUND_Y - 50,
          width: 30,
          height: 50,
          tried: false,
          interactRange: 40,
        },
        stone: {
          x: 280,
          y: CONFIG.GROUND_Y - 20,
          width: 25,
          height: 20,
          tried: false,
          interactRange: 35,
        },
        food: {
          x: 370,
          y: CONFIG.GROUND_Y - 15,
          width: 20,
          height: 15,
          tried: false,
          interactRange: 35,
        },
        bench: { x: 470, y: CONFIG.GROUND_Y - 35, width: 60, height: 35 },
        book: {
          x: 485,
          y: CONFIG.GROUND_Y - 50,
          width: 20,
          height: 15,
          interactRange: 45,
        },
        lampPost: { x: 560, y: CONFIG.GROUND_Y - 100, width: 20, height: 100 },
        phone: {
          x: 680,
          y: CONFIG.GROUND_Y - 70,
          width: 35,
          height: 70,
          interactRange: 45,
        },
      };

      // ==================== BUILDINGS ====================
      const buildings = [
        {
          x: 0,
          width: 150,
          height: 180,
          color: "#8B4513",
          roofColor: "#4a3728",
          windows: [
            [20, 60],
            [80, 60],
            [20, 120],
          ],
        },
        {
          x: 200,
          width: 120,
          height: 150,
          color: "#CD5C5C",
          roofColor: "#8B3A3A",
          windows: [
            [30, 50],
            [70, 50],
          ],
        },
        {
          x: 350,
          width: 180,
          height: 200,
          color: "#A0522D",
          roofColor: "#6B3E26",
          windows: [
            [30, 60],
            [90, 60],
            [150, 60],
            [60, 130],
          ],
        },
        {
          x: 580,
          width: 100,
          height: 140,
          color: "#BC8F8F",
          roofColor: "#8B6969",
          windows: [
            [25, 50],
            [65, 50],
          ],
        },
        {
          x: 700,
          width: 120,
          height: 170,
          color: "#8B7355",
          roofColor: "#5D4E3A",
          windows: [
            [30, 60],
            [80, 60],
          ],
        },
      ];

      // ==================== INPUT ====================
      const keys = { left: false, right: false, interact: false };

      document.addEventListener("keydown", (e) => {
        if (state.currentDialog || state.gameComplete) return;
        if (e.key === "ArrowLeft" || e.key === "a") keys.left = true;
        if (e.key === "ArrowRight" || e.key === "d") keys.right = true;
        if (e.key === "ArrowUp" || e.key === "e" || e.key === "E") {
          if (!keys.interact) {
            keys.interact = true;
            handleInteraction();
          }
        }
      });

      document.addEventListener("keyup", (e) => {
        if (e.key === "ArrowLeft" || e.key === "a") keys.left = false;
        if (e.key === "ArrowRight" || e.key === "d") keys.right = false;
        if (e.key === "ArrowUp" || e.key === "e" || e.key === "E")
          keys.interact = false;
      });

      // Mobile controls
      const btnLeft = document.getElementById("btnLeft");
      const btnRight = document.getElementById("btnRight");
      const btnAction = document.getElementById("btnAction");

      btnLeft.addEventListener("touchstart", (e) => {
        e.preventDefault();
        keys.left = true;
      });
      btnLeft.addEventListener("touchend", () => (keys.left = false));
      btnRight.addEventListener("touchstart", (e) => {
        e.preventDefault();
        keys.right = true;
      });
      btnRight.addEventListener("touchend", () => (keys.right = false));
      btnAction.addEventListener("touchstart", (e) => {
        e.preventDefault();
        handleInteraction();
      });

      // ==================== INTERACTION SYSTEM ====================
      function getNearbyObject() {
        const playerCenter = player.x + player.width / 2;
        const interactables = [
          { name: "tree", obj: objects.tree },
          { name: "ladder", obj: objects.ladder },
          { name: "stone", obj: objects.stone },
          { name: "food", obj: objects.food },
          { name: "book", obj: objects.book },
          { name: "phone", obj: objects.phone },
        ];

        for (const item of interactables) {
          const objCenter = item.obj.x + item.obj.width / 2;
          const distance = Math.abs(playerCenter - objCenter);
          if (distance < (item.obj.interactRange || 40)) {
            return item.name;
          }
        }
        return null;
      }

      function handleInteraction() {
        if (state.currentDialog || state.gameComplete) return;
        const nearby = getNearbyObject();
        if (!nearby) return;

        switch (nearby) {
          case "tree":
            playMeow();
            if (!state.treeInteracted) {
              state.treeInteracted = true;
              showDialog(
                "tree",
                "üå≥",
                "Pohon Tua",
                '"Seekor kucing tersangkut di cabang atas.\nTerlalu tinggi untuk dijangkau.\nBagaimana cara menolongnya?"',
              );
            } else {
              const isNight = timeOrder[currentTimeIndex] === "NIGHT";
              const message = isNight
                ? '"Ia masih di sana,\nmenunggumu menemukan cara.\n\nMalamnya semakin dingin..."'
                : '"Ia masih di sana,\nmenunggumu menemukan cara."';
              showDialog("tree", "üê±", "Kucing di Pohon", message);
            }
            break;
          case "ladder":
            if (!state.ladderTried) {
              playBuzz();
              state.ladderTried = true;
              objects.ladder.tried = true;
              showDialog(
                "ladder",
                "ü™ú",
                "Tangga",
                '"Terlalu pendek.\nTidak akan sampai."',
              );
            }
            break;
          case "stone":
            if (!state.stoneTried) {
              playBuzz();
              state.stoneTried = true;
              objects.stone.tried = true;
              showDialog(
                "stone",
                "ü™®",
                "Batu",
                '"Bukan ide yang baik.\nKucing itu bisa terluka."',
              );
            }
            break;
          case "food":
            if (!state.foodTried) {
              playBuzz();
              state.foodTried = true;
              objects.food.tried = true;
              showDialog(
                "food",
                "üêü",
                "Makanan",
                '"Ia melihatmu sejenak...\nlalu memalingkan wajah."',
              );
            }
            break;
          case "book":
            playDing();
            showBookDialog();
            break;
          case "phone":
            handlePhoneInteraction();
            break;
        }
      }

      function showBookDialog() {
        const content = state.bookRead
          ? `<span class="rule">Cobalah semua cara yang kamu tahu.</span>
<span class="rule">Jangan terburu-buru meminta bantuan.</span>
<span class="rule">Telepon darurat hanya aktif di malam hari.</span>
<span class="rule">Jika kucing belum selamat, gunakan kode yang diberikan.</span>`
          : `"Jika semua cara telah dicoba,
bantuan hanya bisa dipanggil
dengan kode yang tepat."`;

        showDialog(
          "book",
          "üìï",
          "Buku Catatan",
          content,
          state.bookRead ? null : "Baca Aturan",
          "Tutup",
          state.bookRead
            ? null
            : () => {
                playDing();
                state.bookRead = true;
                showBookDialog();
              },
        );
      }

      function handlePhoneInteraction() {
        // GAMEPLAY TWIST: Phone only works at night (emergency hotline)
        if (timeOrder[currentTimeIndex] !== "NIGHT") {
          playBuzz();
          showDialog(
            "phone",
            "üìû",
            "Telepon Darurat",
            '"Layanan ini hanya tersedia\npada malam hari.\n\nüí° Coba ubah waktu ke MALAM"',
          );
          return;
        }

        const allTried =
          state.ladderTried && state.stoneTried && state.foodTried;

        if (!allTried) {
          playBuzz();
          showDialog(
            "phone",
            "üìû",
            "Telepon",
            '"Belum saatnya.\nMasih ada yang bisa dicoba."',
          );
          return;
        }

        if (!state.bookRead) {
          playBuzz();
          showDialog(
            "phone",
            "üìû",
            "Telepon",
            '"Sepertinya ada sesuatu\nyang perlu kamu baca dulu."',
          );
          return;
        }

        playDing();
        state.phoneUnlocked = true;
        showCodeInputDialog();
      }

      function showCodeInputDialog() {
        showDialog(
          "code",
          "üìû",
          "Masukkan Kode Bantuan",
          "Masukkan kode yang diberikan\nuntuk memanggil bantuan.",
          "Kirim",
          "Batal",
          () => {
            const input = document.getElementById("codeInput");
            const code = input.value.trim().toUpperCase();

            if (code === CONFIG.SECRET_CODE) {
              playDing();
              closeDialog();
              triggerEnding();
            } else {
              playBuzz();
              input.value = "";
              input.placeholder = "Tidak ada yang terjadi...";
              setTimeout(() => {
                input.placeholder = "_ _ _ _ _";
              }, 2000);
            }
          },
          true,
        );
      }

      function triggerEnding() {
        state.gameComplete = true;
        objects.cat.rescued = true;
        objects.cat.state = "descending";
        playVictory();

        const rescueInterval = setInterval(() => {
          objects.cat.y += 2;
          if (objects.cat.y >= CONFIG.GROUND_Y - 30) {
            clearInterval(rescueInterval);
            objects.cat.y = CONFIG.GROUND_Y - 30;
            objects.cat.state = "walkingToPlayer";
            objects.cat.targetX = player.x;
            playMeow();
            setTimeout(() => playPurr(), 500);
          }
        }, 30);
      }

      // ==================== DIALOG SYSTEM ====================
      function showDialog(
        type,
        icon,
        title,
        content,
        primaryBtn = null,
        secondaryBtn = "Tutup",
        primaryAction = null,
        showCodeInput = false,
      ) {
        state.currentDialog = type;

        document.getElementById("dialogIcon").textContent = icon;
        document.getElementById("dialogTitle").textContent = title;
        document.getElementById("dialogContent").innerHTML = content;

        const btnPrimary = document.getElementById("btnPrimary");
        const btnSecondary = document.getElementById("btnSecondary");
        const codeWrapper = document.getElementById("codeInputWrapper");
        const codeInput = document.getElementById("codeInput");
        const whatsappBtn = document.getElementById("whatsappBtn");

        codeWrapper.style.display = showCodeInput ? "block" : "none";
        whatsappBtn.style.display = showCodeInput ? "block" : "none";
        if (showCodeInput) {
          codeInput.value = "";
          codeInput.placeholder = "_ _ _ _ _";
          setTimeout(() => codeInput.focus(), 100);
        }

        if (primaryBtn) {
          btnPrimary.style.display = "block";
          btnPrimary.textContent = primaryBtn;
          btnPrimary.onclick = () => {
            if (primaryAction) primaryAction();
            else closeDialog();
          };
        } else {
          btnPrimary.style.display = "none";
        }

        btnSecondary.textContent = secondaryBtn;
        btnSecondary.onclick = closeDialog;

        document.getElementById("dialogOverlay").classList.add("active");
      }

      function closeDialog() {
        document.getElementById("dialogOverlay").classList.remove("active");
        state.currentDialog = null;
      }

      document.getElementById("codeInput").addEventListener("keydown", (e) => {
        if (e.key === "Enter") document.getElementById("btnPrimary").click();
      });

      // ==================== ANIMATIONS ====================
      function updateAnimations() {
        anim.time++;

        // Cloud drift - slower at evening/night
        const cloudSpeedMultiplier = currentTime.ambientSound ? 1 : 0.5;
        anim.clouds.forEach((cloud) => {
          cloud.x += cloud.speed * cloudSpeedMultiplier;
          if (cloud.x > CONFIG.GAME_WIDTH + 80) cloud.x = -80;
        });

        // Cat tail wag
        anim.catTail = Math.sin(anim.time * 0.1) * 0.3;

        // Tree sway
        anim.treeSway = Math.sin(anim.time * 0.03) * 3;

        // Lamp flicker - more active at night
        if (currentTime.lampBrightness > 0.5) {
          anim.lampFlicker = 0.85 + Math.random() * 0.15;
        } else {
          anim.lampFlicker = 0.9 + Math.random() * 0.1;
        }

        // Grass wave
        anim.grassWave = Math.sin(anim.time * 0.05);
      }

      // ==================== UPDATE ====================
      let lastFootstepFrame = 0;

      function update() {
        // Don't update game until intro is passed
        if (!state.introPassed) {
          player.isWalking = false;
          return;
        }

        // Update cutscene
        if (state.cutscene.active) {
          updateCutscene();
          // During cutscene phase 3, let update handle walking animation
          if (state.cutscene.phase !== 3) {
            player.isWalking = false;
            return;
          }
        }

        // Update cat behavior if rescued
        if (objects.cat.rescued) {
          updateCatBehavior();
        }

        if (state.currentDialog) {
          player.isWalking = false;
          return;
        }

        // Allow player movement even after rescue (for cat following)
        player.isWalking = false;
        if (keys.left) {
          player.x -= player.speed;
          player.direction = -1;
          player.isWalking = true;
        }
        if (keys.right) {
          player.x += player.speed;
          player.direction = 1;
          player.isWalking = true;
        }

        player.x = Math.max(
          10,
          Math.min(CONFIG.GAME_WIDTH - player.width - 10, player.x),
        );

        if (player.isWalking) {
          player.frameTimer++;
          if (player.frameTimer > 8) {
            player.frame = (player.frame + 1) % 4;
            player.frameTimer = 0;
            // Play footstep sound on frame change
            if (
              player.frame !== lastFootstepFrame &&
              (player.frame === 0 || player.frame === 2)
            ) {
              playFootstep();
              lastFootstepFrame = player.frame;
            }
          }
        } else {
          player.frame = 0;
        }

        updateInteractPrompt();
      }

      function updateCatBehavior() {
        const cat = objects.cat;

        if (cat.state === "walkingToPlayer") {
          const distanceToPlayer = player.x - cat.x;

          if (Math.abs(distanceToPlayer) > 35) {
            // Calculate midpoint
            const midpoint = (cat.x + player.x) / 2;

            // Cat walks towards midpoint
            cat.direction = distanceToPlayer > 0 ? 1 : -1;
            cat.x += cat.direction * 1.5;

            // Player also walks towards midpoint
            const distanceToMidpoint = midpoint - player.x;
            if (Math.abs(distanceToMidpoint) > 5) {
              player.direction = distanceToMidpoint > 0 ? 1 : -1;
              player.x += player.direction * 1.2;
              player.isWalking = true;

              // Player walking animation
              player.frameTimer++;
              if (player.frameTimer > 8) {
                player.frame = (player.frame + 1) % 4;
                player.frameTimer = 0;
              }
            }

            // Cat walking animation
            cat.frameTimer++;
            if (cat.frameTimer > 6) {
              cat.frame = (cat.frame + 1) % 4;
              cat.frameTimer = 0;
            }
          } else {
            // Reached each other, start rubbing
            cat.state = "rubbing";
            cat.frame = 0;
            cat.rubbingTimer = 0;
            player.isWalking = false;
            player.frame = 0;
            playPurr();
          }
        } else if (cat.state === "rubbing") {
          cat.rubbingTimer++;

          // Rubbing animation (moving around player's feet)
          const rubAngle = (cat.rubbingTimer * 0.1) % (Math.PI * 2);
          cat.x = player.x + Math.cos(rubAngle) * 20;
          cat.direction = Math.cos(rubAngle) > 0 ? 1 : -1;

          // After rubbing for a while, trigger cutscene
          if (cat.rubbingTimer > 120) {
            cat.state = "idle";
            cat.x = player.x;
            // Start cutscene
            state.cutscene.active = true;
            state.cutscene.phase = 0;
            state.cutscene.timer = 0;
          }
        } else if (cat.state === "following") {
          // Follow player at a distance
          const distanceToPlayer = player.x - cat.x;
          const followDistance = 40;

          if (Math.abs(distanceToPlayer) > followDistance + 10) {
            cat.direction = distanceToPlayer > 0 ? 1 : -1;
            cat.x += cat.direction * 2;

            cat.frameTimer++;
            if (cat.frameTimer > 6) {
              cat.frame = (cat.frame + 1) % 4;
              cat.frameTimer = 0;
            }
          } else {
            cat.frame = 0;
          }
        }
      }

      function updateCutscene() {
        if (!state.cutscene.active) return;

        const cs = state.cutscene;
        cs.timer++;

        // Smooth zoom interpolation
        cs.zoomLevel += (cs.targetZoom - cs.zoomLevel) * 0.05;

        // Phase 0: Zoom into happy cat (close-up)
        if (cs.phase === 0) {
          cs.targetZoom = 2.5;
          cs.cameraX = objects.cat.x;
          cs.cameraY = objects.cat.y - 20;

          if (cs.timer > 90) {
            cs.phase = 1;
            cs.timer = 0;
            cs.targetZoom = 1.5;
          }
        }
        // Phase 1: Player picks up cat
        else if (cs.phase === 1) {
          cs.targetZoom = 1.5;
          cs.cameraX = player.x;
          cs.cameraY = player.y - 20;

          if (cs.timer === 1) {
            playMeow();
          }
          if (cs.timer > 30 && cs.timer < 60) {
            // Animate cat moving to player's arms
            objects.cat.y = player.y - 20 - ((cs.timer - 30) / 30) * 20;
          }
          if (cs.timer === 60) {
            player.carryingCat = true;
            objects.cat.carried = true;
          }

          if (cs.timer > 90) {
            cs.phase = 2;
            cs.timer = 0;
          }
        }
        // Phase 2: "Thank you!" dialog from cat
        else if (cs.phase === 2) {
          if (cs.timer === 1) {
            playPurr();
            showDialog(
              "cat",
              "üê±",
              "Kucing",
              '"Terima kasih sudah menolongku!\n\nAku hampir tidak percaya\nada yang peduli..."\n\nüíõ',
              null,
              "Sama-sama! üòä",
              null,
            );
          }

          // Wait for dialog to close
          if (!state.currentDialog && cs.timer > 10) {
            cs.phase = 3;
            cs.timer = 0;
            cs.targetZoom = 1;
          }
        }
        // Phase 3: Walk home together
        else if (cs.phase === 3) {
          cs.targetZoom = 1;
          cs.cameraX = CONFIG.GAME_WIDTH / 2;
          cs.cameraY = CONFIG.GAME_HEIGHT / 2;

          // Auto-walk player to right
          if (cs.timer < 120) {
            player.x += 2;
            player.direction = 1;
            player.isWalking = true;

            if (cs.timer % 15 === 0) {
              playFootstep();
            }
          }

          if (cs.timer > 150) {
            cs.phase = 4;
            cs.timer = 0;
          }
        }
        // Phase 4: Show photo ending
        else if (cs.phase === 4) {
          if (cs.timer === 1) {
            playVictory();
            const ending = document.getElementById("endingOverlay");
            ending.classList.add("active");
            setTimeout(() => ending.classList.add("visible"), 100);
          }
        }
      }

      function updateInteractPrompt() {
        const nearby = getNearbyObject();
        const prompt = document.getElementById("interactPrompt");

        if (nearby && !state.currentDialog) {
          if (
            (nearby === "ladder" && state.ladderTried) ||
            (nearby === "stone" && state.stoneTried) ||
            (nearby === "food" && state.foodTried)
          ) {
            prompt.classList.remove("visible");
            return;
          }

          const obj = objects[nearby];

          // Calculate scale factor for mobile
          const canvasRect = canvas.getBoundingClientRect();
          const scaleX = canvasRect.width / CONFIG.GAME_WIDTH;
          const scaleY = canvasRect.height / CONFIG.GAME_HEIGHT;

          // Position with scaling - adjusted for icon + text height
          const scaledX = (obj.x + obj.width / 2) * scaleX;
          const scaledY = obj.y * scaleY;

          prompt.style.left = scaledX - 35 + "px";
          prompt.style.top = scaledY - 60 + "px";
          prompt.classList.add("visible");
        } else {
          prompt.classList.remove("visible");
        }
      }

      // ==================== RENDER ====================
      function render() {
        ctx.clearRect(0, 0, CONFIG.GAME_WIDTH, CONFIG.GAME_HEIGHT);

        // Draw sky first without transformation (fills entire canvas)
        drawSky();
        if (currentTime.stars) drawStars();

        // Apply camera transformation for cutscene
        ctx.save();
        if (state.cutscene.active) {
          const zoom = state.cutscene.zoomLevel;
          const centerX = CONFIG.GAME_WIDTH / 2;
          const centerY = CONFIG.GAME_HEIGHT / 2;

          // Translate to center, apply zoom, translate to camera position
          ctx.translate(centerX, centerY);
          ctx.scale(zoom, zoom);
          ctx.translate(-state.cutscene.cameraX, -state.cutscene.cameraY);
        }

        drawClouds();
        drawBuildings();
        drawTree();
        drawCat();
        drawStreet();
        drawObjects();
        drawPlayer();

        ctx.restore();
      }

      function drawSky() {
        const gradient = ctx.createLinearGradient(0, 0, 0, CONFIG.GAME_HEIGHT);
        const colors = currentTime.skyGradient;

        // Distribute color stops evenly
        colors.forEach((color, index) => {
          const position = index / (colors.length - 1);
          gradient.addColorStop(position, color);
        });

        ctx.fillStyle = gradient;
        ctx.fillRect(0, 0, CONFIG.GAME_WIDTH, CONFIG.GAME_HEIGHT);
      }

      function drawStars() {
        stars.forEach((star) => {
          const twinkle = Math.sin(anim.time * star.twinkleSpeed) * 0.5 + 0.5;
          ctx.fillStyle = `rgba(255, 255, 255, ${star.brightness * twinkle})`;
          ctx.beginPath();
          ctx.arc(star.x, star.y, star.size, 0, Math.PI * 2);
          ctx.fill();
        });
      }

      function drawClouds() {
        // Morning clouds get soft golden tint
        if (timeOrder[currentTimeIndex] === "MORNING") {
          ctx.fillStyle = `rgba(255, 250, 240, ${currentTime.cloudOpacity})`;
        }
        // Evening clouds get warm pink/orange tint
        else if (timeOrder[currentTimeIndex] === "EVENING") {
          ctx.fillStyle = `rgba(255, 182, 193, ${currentTime.cloudOpacity})`;
        } else {
          ctx.fillStyle = `rgba(255, 255, 255, ${currentTime.cloudOpacity})`;
        }

        const cloudY = [50, 30, 60, 40];
        const cloudScale = [1, 0.8, 1.2, 0.7];
        anim.clouds.forEach((cloud, i) => {
          drawCloud(cloud.x, cloudY[i], cloudScale[i]);
        });
      }

      function drawCloud(x, y, scale) {
        ctx.save();
        ctx.translate(x, y);
        ctx.scale(scale, scale);
        ctx.beginPath();
        ctx.arc(0, 0, 20, 0, Math.PI * 2);
        ctx.arc(25, -5, 25, 0, Math.PI * 2);
        ctx.arc(50, 0, 20, 0, Math.PI * 2);
        ctx.arc(15, 10, 15, 0, Math.PI * 2);
        ctx.arc(35, 10, 18, 0, Math.PI * 2);
        ctx.fill();
        ctx.restore();
      }

      function drawBuildings() {
        buildings.forEach((b, i) => {
          const baseY = CONFIG.GROUND_Y - b.height + 50;

          // Draw building body
          ctx.fillStyle = b.color;
          ctx.fillRect(b.x, baseY, b.width, b.height);

          // Draw roof
          ctx.fillStyle = b.roofColor;
          ctx.fillRect(b.x - 5, baseY - 15, b.width + 10, 20);

          // Draw brick texture - with proper clipping
          ctx.save();
          ctx.beginPath();
          ctx.rect(b.x, baseY, b.width, b.height);
          ctx.clip();

          ctx.strokeStyle = "rgba(0,0,0,0.1)";
          ctx.lineWidth = 1;

          const brickHeight = 12;
          const brickWidth = 25;

          for (let row = 0; row < Math.ceil(b.height / brickHeight); row++) {
            const offset = row % 2 === 0 ? 0 : -12;
            for (
              let col = 0;
              col < Math.ceil((b.width + 12) / brickWidth);
              col++
            ) {
              const bx = b.x + col * brickWidth + offset;
              const by = baseY + row * brickHeight;

              // Only draw if within building bounds
              if (bx >= b.x && bx < b.x + b.width && by < baseY + b.height) {
                ctx.strokeRect(bx, by, brickWidth, brickHeight);
              }
            }
          }

          ctx.restore();

          b.windows.forEach(([wx, wy]) => {
            // Window lights based on time of day
            if (currentTime.windowLights) {
              ctx.fillStyle = "#FFE5B4";
            } else {
              ctx.fillStyle = "#5a8fba";
            }
            ctx.fillRect(b.x + wx, baseY + wy, 25, 30);
            ctx.strokeStyle = "#3d5a73";
            ctx.lineWidth = 2;
            ctx.strokeRect(b.x + wx, baseY + wy, 25, 30);
            ctx.beginPath();
            ctx.moveTo(b.x + wx + 12, baseY + wy);
            ctx.lineTo(b.x + wx + 12, baseY + wy + 30);
            ctx.moveTo(b.x + wx, baseY + wy + 15);
            ctx.lineTo(b.x + wx + 25, baseY + wy + 15);
            ctx.stroke();
          });

          if (i === 0 || i === 2) {
            ctx.fillStyle = "#4a3020";
            ctx.fillRect(
              b.x + b.width / 2 - 15,
              CONFIG.GROUND_Y - 45 + 50,
              30,
              45,
            );
            // Door light only at evening/night
            if (currentTime.windowLights) {
              ctx.fillStyle = "#FFD700";
              ctx.beginPath();
              ctx.arc(
                b.x + b.width / 2 + 8,
                CONFIG.GROUND_Y - 20 + 50,
                3,
                0,
                Math.PI * 2,
              );
              ctx.fill();
            }
          }
        });
      }

      function drawTree() {
        const tree = objects.tree;
        const sway = anim.treeSway;

        ctx.fillStyle = "#5D4037";
        ctx.fillRect(tree.x + 35, tree.y + 40, 30, 80);

        ctx.fillStyle = "#4E342E";
        ctx.fillRect(tree.x + 40, tree.y + 50, 5, 60);

        ctx.fillStyle = "#2E7D32";
        drawTreeCrown(tree.x + 50 + sway * 0.3, tree.y + 60, 55);

        ctx.fillStyle = "#388E3C";
        drawTreeCrown(tree.x + 50 + sway * 0.6, tree.y + 35, 50);

        ctx.fillStyle = "#43A047";
        drawTreeCrown(tree.x + 50 + sway, tree.y + 15, 40);
      }

      function drawTreeCrown(x, y, radius) {
        ctx.beginPath();
        ctx.arc(x, y, radius, 0, Math.PI * 2);
        ctx.fill();
      }

      function drawCat() {
        const cat = objects.cat;

        // Don't draw cat separately if being carried by player
        if (cat.carried) return;

        // Special happy cat rendering for cutscene phase 0 (close-up)
        if (state.cutscene.active && state.cutscene.phase === 0) {
          ctx.save();
          ctx.translate(cat.x, cat.y);

          // Bigger, happier cat for closeup
          ctx.fillStyle = "#FF9800";
          ctx.fillRect(-5, 10, 30, 20);

          // Head
          ctx.beginPath();
          ctx.arc(12, 6, 12, 0, Math.PI * 2);
          ctx.fill();

          // Ears
          ctx.beginPath();
          ctx.moveTo(2, 0);
          ctx.lineTo(6, -8);
          ctx.lineTo(10, 0);
          ctx.fill();
          ctx.beginPath();
          ctx.moveTo(14, 0);
          ctx.lineTo(18, -8);
          ctx.lineTo(22, 0);
          ctx.fill();

          // Happy closed eyes
          ctx.strokeStyle = "#333";
          ctx.lineWidth = 2;
          ctx.beginPath();
          ctx.arc(7, 5, 3, 0, Math.PI);
          ctx.arc(17, 5, 3, 0, Math.PI);
          ctx.stroke();

          // Big happy smile
          ctx.beginPath();
          ctx.arc(12, 8, 5, 0, Math.PI);
          ctx.stroke();

          // Pink cheeks
          ctx.fillStyle = "rgba(255, 105, 180, 0.5)";
          ctx.beginPath();
          ctx.ellipse(3, 8, 3, 2, 0, 0, Math.PI * 2);
          ctx.ellipse(21, 8, 3, 2, 0, 0, Math.PI * 2);
          ctx.fill();

          // Whiskers
          ctx.strokeStyle = "#333";
          ctx.lineWidth = 1;
          ctx.beginPath();
          ctx.moveTo(2, 6);
          ctx.lineTo(-3, 5);
          ctx.moveTo(2, 8);
          ctx.lineTo(-3, 9);
          ctx.moveTo(22, 6);
          ctx.lineTo(27, 5);
          ctx.moveTo(22, 8);
          ctx.lineTo(27, 9);
          ctx.stroke();

          // Happy waggy tail
          ctx.strokeStyle = "#FF9800";
          ctx.lineWidth = 4;
          ctx.lineCap = "round";
          ctx.beginPath();
          ctx.moveTo(25, 18);
          const tailWag = Math.sin(anim.time * 0.3) * 12;
          ctx.quadraticCurveTo(35 + tailWag, 12, 32 + tailWag * 0.5, 0);
          ctx.stroke();

          // Sparkles around happy cat
          ctx.fillStyle = "#FFD700";
          ctx.font = "16px Arial";
          const sparkleOffset = Math.sin(anim.time * 0.2) * 3;
          ctx.fillText("‚ú®", -10 + sparkleOffset, 0);
          ctx.fillText("‚ú®", 30 - sparkleOffset, 0);
          ctx.fillText("‚≠ê", 5, -15 + sparkleOffset);
          ctx.fillText("‚≠ê", 15, -15 - sparkleOffset);

          ctx.restore();
          return;
        }

        // Don't draw cat if in tree and not rescued yet
        if (!cat.rescued && cat.state === "stuck") {
          ctx.save();
          ctx.translate(cat.x, cat.y);

          ctx.fillStyle = "#FF9800";
          ctx.fillRect(0, 10, 25, 15);

          ctx.beginPath();
          ctx.arc(12, 8, 10, 0, Math.PI * 2);
          ctx.fill();

          ctx.beginPath();
          ctx.moveTo(4, 2);
          ctx.lineTo(8, -6);
          ctx.lineTo(12, 2);
          ctx.fill();
          ctx.beginPath();
          ctx.moveTo(12, 2);
          ctx.lineTo(16, -6);
          ctx.lineTo(20, 2);
          ctx.fill();

          ctx.fillStyle = "#333";
          ctx.beginPath();
          ctx.arc(8, 7, 2, 0, Math.PI * 2);
          ctx.arc(16, 7, 2, 0, Math.PI * 2);
          ctx.fill();

          // Animated tail
          ctx.strokeStyle = "#FF9800";
          ctx.lineWidth = 4;
          ctx.lineCap = "round";
          ctx.beginPath();
          ctx.moveTo(25, 15);
          const tailWag = Math.sin(anim.time * 0.15) * 8;
          ctx.quadraticCurveTo(35 + tailWag, 10, 32 + tailWag * 0.5, 0);
          ctx.stroke();

          ctx.restore();
          return;
        }

        // Draw walking/following/rubbing/idle cat
        if (
          cat.rescued &&
          (cat.state === "walkingToPlayer" ||
            cat.state === "rubbing" ||
            cat.state === "following" ||
            cat.state === "idle")
        ) {
          ctx.save();
          ctx.translate(cat.x, cat.y);
          ctx.scale(cat.direction, 1);

          // Walking animation bob
          const bobOffset =
            cat.state !== "rubbing" && cat.frame > 0
              ? Math.sin((cat.frame * Math.PI) / 2) * 2
              : 0;

          // Shadow
          ctx.fillStyle = "rgba(0,0,0,0.2)";
          ctx.beginPath();
          ctx.ellipse(12, 28, 10, 3, 0, 0, Math.PI * 2);
          ctx.fill();

          // Body
          ctx.fillStyle = "#FF9800";
          ctx.fillRect(2, 12 - bobOffset, 20, 12);

          // Head
          ctx.beginPath();
          ctx.arc(12, 8 - bobOffset, 8, 0, Math.PI * 2);
          ctx.fill();

          // Ears
          ctx.beginPath();
          ctx.moveTo(6, 2 - bobOffset);
          ctx.lineTo(8, -4 - bobOffset);
          ctx.lineTo(10, 2 - bobOffset);
          ctx.fill();
          ctx.beginPath();
          ctx.moveTo(14, 2 - bobOffset);
          ctx.lineTo(16, -4 - bobOffset);
          ctx.lineTo(18, 2 - bobOffset);
          ctx.fill();

          // Eyes
          ctx.fillStyle = "#333";
          ctx.beginPath();
          ctx.arc(8, 7 - bobOffset, 1.5, 0, Math.PI * 2);
          ctx.arc(16, 7 - bobOffset, 1.5, 0, Math.PI * 2);
          ctx.fill();

          // Legs animation
          if (cat.state === "walkingToPlayer" || cat.state === "following") {
            ctx.fillStyle = "#FF9800";
            const legOffset = Math.sin((cat.frame * Math.PI) / 2) * 4;

            // Front legs
            ctx.fillRect(6 + legOffset, 24 - bobOffset, 3, 6);
            ctx.fillRect(12 - legOffset, 24 - bobOffset, 3, 6);

            // Back legs
            ctx.fillRect(15 + legOffset, 24 - bobOffset, 3, 6);
            ctx.fillRect(9 - legOffset, 24 - bobOffset, 3, 6);
          } else {
            // Standing legs
            ctx.fillStyle = "#FF9800";
            ctx.fillRect(6, 24, 3, 6);
            ctx.fillRect(12, 24, 3, 6);
            ctx.fillRect(15, 24, 3, 6);
            ctx.fillRect(9, 24, 3, 6);
          }

          // Tail - happier wag when rubbing
          ctx.strokeStyle = "#FF9800";
          ctx.lineWidth = 3;
          ctx.lineCap = "round";
          ctx.beginPath();
          ctx.moveTo(20, 15 - bobOffset);
          const tailSpeed = cat.state === "rubbing" ? 0.3 : 0.15;
          const tailWag =
            Math.sin(anim.time * tailSpeed) *
            (cat.state === "rubbing" ? 15 : 8);
          ctx.quadraticCurveTo(
            28 + tailWag,
            10 - bobOffset,
            26 + tailWag * 0.5,
            2 - bobOffset,
          );
          ctx.stroke();

          // Heart particle when rubbing
          if (cat.state === "rubbing" && cat.rubbingTimer % 30 < 15) {
            ctx.fillStyle = "#FF69B4";
            ctx.font = "12px Arial";
            ctx.fillText("‚ù§", 15, -5 - bobOffset);
          }

          ctx.restore();
        }

        // Draw descending cat
        if (cat.rescued && cat.state === "descending") {
          ctx.save();
          ctx.translate(cat.x, cat.y);

          ctx.fillStyle = "#FF9800";
          ctx.fillRect(0, 10, 25, 15);

          ctx.beginPath();
          ctx.arc(12, 8, 10, 0, Math.PI * 2);
          ctx.fill();

          ctx.beginPath();
          ctx.moveTo(4, 2);
          ctx.lineTo(8, -6);
          ctx.lineTo(12, 2);
          ctx.fill();
          ctx.beginPath();
          ctx.moveTo(12, 2);
          ctx.lineTo(16, -6);
          ctx.lineTo(20, 2);
          ctx.fill();

          ctx.fillStyle = "#333";
          ctx.beginPath();
          ctx.arc(8, 7, 2, 0, Math.PI * 2);
          ctx.arc(16, 7, 2, 0, Math.PI * 2);
          ctx.fill();

          ctx.strokeStyle = "#FF9800";
          ctx.lineWidth = 4;
          ctx.lineCap = "round";
          ctx.beginPath();
          ctx.moveTo(25, 15);
          ctx.lineTo(28, 8);
          ctx.stroke();

          ctx.restore();
        }
      }

      function drawStreet() {
        ctx.fillStyle = "#9E9E9E";
        ctx.fillRect(0, CONFIG.GROUND_Y, CONFIG.GAME_WIDTH, 30);

        drawGrass();

        ctx.fillStyle = "#757575";
        ctx.fillRect(0, CONFIG.GROUND_Y + 25, CONFIG.GAME_WIDTH, 5);

        ctx.fillStyle = "#424242";
        ctx.fillRect(0, CONFIG.GROUND_Y + 30, CONFIG.GAME_WIDTH, 50);

        ctx.fillStyle = "#FFF";
        for (let i = 0; i < 10; i++) {
          ctx.fillRect(50 + i * 85, CONFIG.GROUND_Y + 52, 40, 6);
        }

        ctx.fillStyle = "#616161";
        ctx.fillRect(0, CONFIG.GROUND_Y + 28, CONFIG.GAME_WIDTH, 4);

        ctx.fillStyle = "#FFF";
        for (let i = 0; i < 6; i++) {
          ctx.fillRect(620 + i * 25, CONFIG.GROUND_Y + 30, 15, 50);
        }
      }

      function drawGrass() {
        const grassPositions = [160, 240, 330, 420, 550, 650];
        grassPositions.forEach((gx, i) => {
          const wave = Math.sin(anim.time * 0.08 + i) * 2;
          ctx.fillStyle = "#4CAF50";

          for (let j = 0; j < 3; j++) {
            ctx.save();
            ctx.translate(gx + j * 6, CONFIG.GROUND_Y);
            ctx.rotate((wave + j * 0.5) * 0.05);
            ctx.fillRect(-1, -12, 2, 12);
            ctx.restore();
          }

          if (i % 2 === 0) {
            ctx.fillStyle = i % 4 === 0 ? "#FF5722" : "#E91E63";
            ctx.beginPath();
            ctx.arc(
              gx + 8 + wave * 0.5,
              CONFIG.GROUND_Y - 14,
              3,
              0,
              Math.PI * 2,
            );
            ctx.fill();
            ctx.fillStyle = "#FFEB3B";
            ctx.beginPath();
            ctx.arc(
              gx + 8 + wave * 0.5,
              CONFIG.GROUND_Y - 14,
              1.5,
              0,
              Math.PI * 2,
            );
            ctx.fill();
          }
        });
      }

      function drawObjects() {
        if (!objects.ladder.tried) {
          drawLadder(objects.ladder.x, objects.ladder.y);
        } else {
          ctx.globalAlpha = 0.3;
          drawLadder(objects.ladder.x, objects.ladder.y);
          ctx.globalAlpha = 1;
        }

        if (!objects.stone.tried) {
          drawStone(objects.stone.x, objects.stone.y);
        } else {
          ctx.globalAlpha = 0.3;
          drawStone(objects.stone.x, objects.stone.y);
          ctx.globalAlpha = 1;
        }

        if (!objects.food.tried) {
          drawFood(objects.food.x, objects.food.y);
        } else {
          ctx.globalAlpha = 0.3;
          drawFood(objects.food.x, objects.food.y);
          ctx.globalAlpha = 1;
        }

        drawBench(objects.bench.x, objects.bench.y);
        drawBook(objects.book.x, objects.book.y);
        drawLampPost(objects.lampPost.x, objects.lampPost.y);
        drawPhoneBooth(objects.phone.x, objects.phone.y);
      }

      function drawLadder(x, y) {
        ctx.fillStyle = "#8D6E63";
        ctx.fillRect(x, y, 5, 50);
        ctx.fillRect(x + 22, y, 5, 50);
        for (let i = 0; i < 5; i++) {
          ctx.fillRect(x + 3, y + 5 + i * 10, 21, 3);
        }
      }

      function drawStone(x, y) {
        ctx.fillStyle = "#757575";
        ctx.beginPath();
        ctx.ellipse(x + 12, y + 10, 15, 10, 0, 0, Math.PI * 2);
        ctx.fill();
        ctx.fillStyle = "#9E9E9E";
        ctx.beginPath();
        ctx.ellipse(x + 8, y + 6, 5, 3, -0.3, 0, Math.PI * 2);
        ctx.fill();
      }

      function drawFood(x, y) {
        ctx.fillStyle = "#64B5F6";
        ctx.beginPath();
        ctx.ellipse(x + 10, y + 8, 12, 7, 0, 0, Math.PI * 2);
        ctx.fill();
        ctx.beginPath();
        ctx.moveTo(x + 20, y + 8);
        ctx.lineTo(x + 28, y + 2);
        ctx.lineTo(x + 28, y + 14);
        ctx.closePath();
        ctx.fill();
        ctx.fillStyle = "#333";
        ctx.beginPath();
        ctx.arc(x + 5, y + 6, 2, 0, Math.PI * 2);
        ctx.fill();
      }

      function drawBench(x, y) {
        ctx.fillStyle = "#8D6E63";
        ctx.fillRect(x, y + 15, 60, 8);
        ctx.fillRect(x + 5, y, 50, 5);
        ctx.fillRect(x + 5, y + 7, 50, 5);
        ctx.fillStyle = "#5D4037";
        ctx.fillRect(x + 5, y + 20, 6, 18);
        ctx.fillRect(x + 49, y + 20, 6, 18);
        ctx.fillRect(x + 5, y, 4, 20);
        ctx.fillRect(x + 51, y, 4, 20);
      }

      function drawBook(x, y) {
        ctx.fillStyle = "#C62828";
        ctx.fillRect(x, y, 20, 15);
        ctx.fillStyle = "#FFF8E1";
        ctx.fillRect(x + 2, y + 2, 16, 11);
        ctx.fillStyle = "#8E0000";
        ctx.fillRect(x, y, 3, 15);
      }

      function drawLampPost(x, y) {
        ctx.fillStyle = "#37474F";
        ctx.fillRect(x + 8, y + 20, 6, 80);
        ctx.fillRect(x + 2, y + 95, 18, 8);

        ctx.fillStyle = "#455A64";
        ctx.fillRect(x - 5, y, 32, 25);

        const flicker = anim.lampFlicker * currentTime.lampBrightness;
        ctx.fillStyle = `rgba(255, 249, 196, ${flicker})`;
        ctx.fillRect(x, y + 20, 22, 5);

        if (currentTime.lampBrightness > 0) {
          ctx.fillStyle = `rgba(255, 249, 196, ${0.3 * flicker})`;
          ctx.beginPath();
          ctx.moveTo(x, y + 25);
          ctx.lineTo(x - 15, y + 80);
          ctx.lineTo(x + 37, y + 80);
          ctx.lineTo(x + 22, y + 25);
          ctx.fill();
        }
      }

      function drawPhoneBooth(x, y) {
        ctx.fillStyle = "#C62828";
        ctx.fillRect(x, y, 35, 70);
        ctx.fillStyle = "#FFEBEE";
        ctx.fillRect(x + 4, y + 4, 27, 50);
        ctx.fillStyle = "#81D4FA";
        ctx.fillRect(x + 6, y + 6, 23, 30);
        ctx.fillStyle = "#333";
        ctx.fillRect(x + 12, y + 40, 12, 8);
        ctx.fillStyle = "#B71C1C";
        ctx.fillRect(x - 2, y - 5, 39, 8);
        ctx.fillStyle = "#FFF";
        ctx.font = "8px Arial";
        ctx.fillText("TEL", x + 10, y + 62);
      }

      function drawPlayer() {
        ctx.save();
        ctx.translate(player.x + player.width / 2, player.y);
        ctx.scale(player.direction, 1);
        ctx.translate(-player.width / 2, 0);

        const bobOffset = player.isWalking
          ? Math.sin((player.frame * Math.PI) / 2) * 2
          : 0;

        ctx.fillStyle = "rgba(0,0,0,0.2)";
        ctx.beginPath();
        ctx.ellipse(16, 48, 12, 4, 0, 0, Math.PI * 2);
        ctx.fill();

        ctx.fillStyle = "#5D4037";
        if (player.isWalking) {
          const legOffset = Math.sin((player.frame * Math.PI) / 2) * 6;
          ctx.fillRect(8 + legOffset, 35 - bobOffset, 7, 13);
          ctx.fillRect(17 - legOffset, 35 - bobOffset, 7, 13);
        } else {
          ctx.fillRect(10, 35, 6, 13);
          ctx.fillRect(16, 35, 6, 13);
        }

        ctx.fillStyle = "#7B1FA2";
        ctx.fillRect(6, 20 - bobOffset, 20, 18);

        ctx.fillStyle = "#9C27B0";
        ctx.fillRect(8, 22 - bobOffset, 16, 4);

        ctx.fillStyle = "#FFCCBC";
        if (player.isWalking) {
          const armOffset = Math.sin((player.frame * Math.PI) / 2) * 4;
          // If carrying cat, arms hold cat
          if (player.carryingCat) {
            ctx.fillRect(3, 22 - bobOffset, 5, 10);
            ctx.fillRect(24, 22 - bobOffset, 5, 10);
          } else {
            ctx.fillRect(3, 22 - bobOffset + armOffset, 5, 12);
            ctx.fillRect(24, 22 - bobOffset - armOffset, 5, 12);
          }
        } else {
          ctx.fillRect(3, 24, 5, 10);
          ctx.fillRect(24, 24, 5, 10);
        }

        // Draw cat in player's arms
        if (player.carryingCat) {
          ctx.save();
          ctx.translate(16, 26 - bobOffset);
          ctx.scale(0.7, 0.7);

          // Cat body
          ctx.fillStyle = "#FF9800";
          ctx.fillRect(-8, -4, 16, 10);

          // Cat head
          ctx.beginPath();
          ctx.arc(0, -6, 7, 0, Math.PI * 2);
          ctx.fill();

          // Ears
          ctx.beginPath();
          ctx.moveTo(-4, -10);
          ctx.lineTo(-2, -13);
          ctx.lineTo(0, -10);
          ctx.fill();
          ctx.beginPath();
          ctx.moveTo(0, -10);
          ctx.lineTo(2, -13);
          ctx.lineTo(4, -10);
          ctx.fill();

          // Eyes (happy closed)
          ctx.strokeStyle = "#333";
          ctx.lineWidth = 1.5;
          ctx.beginPath();
          ctx.arc(-3, -6, 1, 0, Math.PI);
          ctx.arc(3, -6, 1, 0, Math.PI);
          ctx.stroke();

          // Happy mouth
          ctx.beginPath();
          ctx.arc(0, -4.5, 2, 0, Math.PI);
          ctx.stroke();

          // Tail wrapped around
          ctx.strokeStyle = "#FF9800";
          ctx.lineWidth = 2;
          ctx.beginPath();
          ctx.moveTo(8, 0);
          ctx.quadraticCurveTo(12, -2, 10, -6);
          ctx.stroke();

          ctx.restore();
        }

        ctx.fillStyle = "#FFCCBC";
        ctx.beginPath();
        ctx.arc(16, 12 - bobOffset, 10, 0, Math.PI * 2);
        ctx.fill();

        ctx.fillStyle = "#4E342E";
        ctx.beginPath();
        ctx.arc(16, 10 - bobOffset, 10, Math.PI, Math.PI * 2);
        ctx.fill();
        ctx.fillRect(6, 8 - bobOffset, 4, 14);
        ctx.fillRect(22, 8 - bobOffset, 4, 14);

        ctx.strokeStyle = "#333";
        ctx.lineWidth = 1.5;
        ctx.beginPath();
        ctx.arc(12, 12 - bobOffset, 4, 0, Math.PI * 2);
        ctx.arc(20, 12 - bobOffset, 4, 0, Math.PI * 2);
        ctx.stroke();
        ctx.beginPath();
        ctx.moveTo(16, 12 - bobOffset);
        ctx.lineTo(16, 12 - bobOffset);
        ctx.moveTo(8, 12 - bobOffset);
        ctx.lineTo(6, 11 - bobOffset);
        ctx.moveTo(24, 12 - bobOffset);
        ctx.lineTo(26, 11 - bobOffset);
        ctx.stroke();

        ctx.fillStyle = "#333";
        ctx.beginPath();
        ctx.arc(12, 12 - bobOffset, 1.5, 0, Math.PI * 2);
        ctx.arc(20, 12 - bobOffset, 1.5, 0, Math.PI * 2);
        ctx.fill();

        ctx.restore();
      }

      // ==================== GAME LOOP ====================
      function gameLoop() {
        updateAnimations();
        update();
        render();
        requestAnimationFrame(gameLoop);
      }

      gameLoop();
    </script>
  </body>
</html>
